## 疑问
- [ ] 计算loss的时候，都是用真实边框与default box(该边框事先确定)相比求IOU，而不是真实边框与预测边框相比。
***基于如下约束，估算的那么多边框总有一个与真实边框重叠。***
- [ ] SSD的测试阶段，选择边界框很耗时间，论文3.7 inference time中有提到。如何解决


## faster RCNN

### 基本思路

faster rcnn只使用一个feature map，一共产生大概20000个default box。RPN中预测的有没有物体的概率，只在RPN中使用，后面被丢弃了，它只负责从2000个预测边框中选择出300个边框。
样本选择规则：
* 正样本的选择规则：1、与真实边框重叠度最大的那个default box;2、与任一真实边框的重叠度大于0.7。
* 负样本的选择规则：1、与任一真实边框的重叠度都不大于0.3。

### 训练
* 使用anchor生成算法得到所有的anchor;
* 去除边界不符合条件的，四个坐标中出现0或超过边界的；
* 使用score排序，取前12000（训练时）或6000（测试时）
* 使用nms算法进一步过滤，取前2000（训练）或300（测试）
* 在训练阶段，经过nms过滤的2000个anchor，会与真实边框计算overlap，计算出正样本和负样本，计算出RPN的loss。
* 把选出的anchor输入到RoI。在训练阶段，预测的anchor会与真实边框计算overlap，正样本数为128*0.3，其余为负样本数。

### RPN loss计算
* 选出正样本和负样本，计算$$$L({p_i},{t_i})=\frac{1}{n}\sum_{i}L_{cls}(p_i,p_i^*)+\lambda\frac{1}{N_{reg}}\sum_{i}p_i^*L_{reg}(t_i,t_i^*)$$$
其中：
&emsp;&emsp;i为一个mini-batch中一个anchor的索引；
&emsp;&emsp;如果一个anchor为正样本，则真实标签$$$p_i^*$$$为1，否则为0;
&emsp;&emsp;$$$t_i$$$为预测框的4参数坐标，$$$t_i^*$$$为与之对应的真实框的坐标；
&emsp;&emsp;如果一个anchor为正样本，则$$$p_i^*=1$$$，否则为0
* 计算RPN的loss的时候，会选择128个正样本和128个负样本。如果正样本不足128个，使用负样本补充。


### 测试


## SSD

### 基本思路

&emsp;&emsp;***SSD基于如下约束，估算出default box至少有一个与真实边框相近，即 IoU>0.5***

&emsp;&emsp;SSD使用6个feature map，假设feature map的大小为$$$S*S$$$，则每个位置产生B个anchor，21个类概率，表示该边框为该类的概率，每个feature map共生成$$$(S*S)*B*(4+21)$$$个数据。产生的边框与真实边框相匹配产生，最终计算出loss。

### 训练

&emsp;&emsp;SSD一共产生8732个边框。
* 计算出每个default box与每个真实边框的IoU，按照匹配规则为每个default box选出一个真实边框与之匹配。IoU大于阈值（文中使用0.5）的为正样本，其余的为负样本。正样本的类标签为真实边框的类标签。
* 计算出边框回归的loss，即$$$L_{loc}(x,l,g)$$$
* 正样本和负样本按照1：3选择，正样本全部使用。选择概率高的负样本。
* 计算出置信度的loss，即$$$L_{conf}(x,c)$$$

### 测试
* 使用置信度的阈值大于0.01，可以过滤掉大部分的边界框。该处0.01针对类标签的概率，不是背景标签的概率
* 对每个类（不含背景）使用nms，提取前200个边界框。

## yolov1/v2
### 基本思路

&emsp;&emsp;yolov1先把图片分成$$$7*7$$$的grid，每个grid预测2个边框，对每个边框预测5个值，其中4个为边框的坐标，另外一个为置信度confidence=P(object)*IoU，每个grid预测20个条件概率P(class_i|project)。当有物体的中心处在某个grid中时，则该grid的P(object)=1，否则为P(object)=0。

&emsp;&emsp;yolov2先把图片分成$$$13*13$$$的grid，每个grid预测5个边框，与yolov1相同每个边框预测5个值，其中4个为边框的坐标，另一个为置信度confidence。与yolov1不同的是，它每个边框都预测20个条件概率。

### 训练

&emsp;&emsp;对于一张图片来说，真实边框较少，当真实边框落在第i个grid中时，则$$$l_i^{obj}=1$$$，否则$$$l_i^{obj}=0$$$。当$$$l_i^{obj}=1$$$时，如果第j个预测边框与真实边框的IoU最大，则$$$l_{ij}^{obj}=1$$$，否则$$$l_{ij}^{obj}=0$$$。注意如果$$$l_{ij}^{obj}=0$$$，则$$$l_{ij}^{nobj}=1$$$。

&emsp;&emsp;假设一张图片有T个真实边框。
&emsp;&emsp;loss计算的思路如下：
* 由于$$$l_{ij}^{obj}=1$$$比较少，先认为对于所有的边框$$$l_{ij}^{nobj}=1$$$，即所有grid所有预测边框没有一个与真实边框匹配。即先计算$$$\lambda_{nobj}\sum_{i=0}^{s^2}\sum_{j=0}^{B}l_{ij}^{nobj}(C_{ij}-\hat{C}_{ij})^2$$$。
* 其次计算$$$l_i^{obj}=1$$$，即真实边框落在第i个grid。即计算$$$\sum_{i=0}^{s^2}\sum_{c\in{classes}}l_i^{obj}(P_i(c)-\hat{P}_i(c))^2$$$
* 在对第二步进行计算的时候，同时得到与真实边框的IOU最大的边框***j***，然后计算
$$$\lambda_{coord}\sum_{i=0}^{s^2}\sum_{j=0}^{B}l_{ij}^{obj}[(x_i-\hat{x}_i)^2+(y_i-\hat{y}_i)^2]+\sum_{i=0}^{s^2}\sum_{j=0}^{B}l_{ij}^{obj}[(\sqrt{w_i}-\sqrt{\hat{w}_i})^2+(\sqrt{h_i}-\sqrt{\hat{h}_i})^2]+\sum_{i=0}^{s^2}\sum_{j=0}^{obj}l_{ij}^{obj}(C_i-\hat{C}_i)^2$$$。由于第一步多减了一部分，在该处加上。第一步的方法直接默认所有的预测边框都不与真实边框匹配，计算过程中不需要判断，减少计算时间。

### 测试

&emsp;&emsp;直接计算出每个边框中每个类的概率，然后通过阈值，过滤掉绝大部分，最后使用nms过滤掉一部分，直接输出就可以了。







